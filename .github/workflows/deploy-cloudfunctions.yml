name: ç‹—å¤´å†›å¸ˆ - äº‘å‡½æ•°éƒ¨ç½²

on:
  push:
    branches: [main]
    paths:
      - 'cloudfunctions/**'
      - 'scripts/deploy*.js'
      - 'scripts/deploy*.sh'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        
      - name: å®‰è£…å¾®ä¿¡ CLI
        run: npm install --save-dev miniprogram-ci
        
      - name: è§£å¯†ç§é’¥
        env:
          WECHAT_PRIVATE_KEY: ${{ secrets.WECHAT_PRIVATE_KEY }}
        run: |
          echo "$WECHAT_PRIVATE_KEY" > private.key
          chmod 600 private.key
          
      - name: éƒ¨ç½²äº‘å‡½æ•°
        env:
          WECHAT_APPID: ${{ secrets.WECHAT_APPID }}
          WECHAT_PRIVATE_KEY_PATH: ./private.key
          WECHAT_PROJECT_PATH: .
          WECHAT_ENV_ID: ${{ secrets.WECHAT_ENV_ID }}
        run: node scripts/deploy-ci.js
        
      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "âœ… äº‘å‡½æ•°éƒ¨ç½²å®Œæˆ"
          echo ""
          echo "ğŸ“ è¯·åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­:"
          echo "  1. æ‰“å¼€é¡¹ç›®"
          echo "  2. æ£€æŸ¥äº‘å‡½æ•°çŠ¶æ€"
          echo "  3. æäº¤å®¡æ ¸å‘å¸ƒ"
